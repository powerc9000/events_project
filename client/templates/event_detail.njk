{%extends "layout.njk"%} 
{%import "partials/form_messages.njk" as form_messages%} 
{% from "partials/event_detail/topnav.njk" import event_nav%}
{% from "partials/event_detail/invite_to_event.njk" import invite_form%}
{%block content %}
	<div class="container mx-auto content" data-controller="event-detail" data-event-detail-event-id="{{event.id}}">
		{%set discussion = event.allow_comments and user%}
		{%include "partials/event_detail/top_part.njk"%}

		{{event_nav(path, comments.length, "base", allowDiscussion=discussion, canEdit=canEdit)}}
		{%if not user and canRSVP%}
			<div class="bg-blue-100 p-1 border-l-4 border-blue-400 my-2 pl-4">
				<p>You are not logged in. You can still RSVP but other features are limited.</p>
				<a href="/login?redirect_to={{__currentPath() | urlencode}}" class="text-blue-700 hover:underline">Login</a> to enable all features.
			</div>
		{%endif%}
		<div class="sm:flex">
			<div class="flex-1">
				{% call invite_form(invitePath, canInvite)%}
				<div class="ml-2">
					or <a target="_blank" rel="noopener noreferer" class="text-blue-700 hover:underline" href="mailto:events+{{event.email_hash_id}}@{{inboundEmailDomain}}?subject={{event.name | urlencode}}&body={{event.description | striptags| urlencode}}">Bulk Invite Via Email</a>

				</div>
				{%endcall%}
				{%if isCreator %}
					<div data-target="event.detail.shareableLink" data-controller="copy-to-clipboard" class="mt-2 lg:w-2/3 border-gray-200 border p-2">
						<p class="font-bold">Shareable link</p>
						<div class="mb-2">
							{{form_messages.messages("copy")}}
						</div>
						<div class="flex items-center">
							<div class="w-full mr-2">
								<input type="text" value="https://junipercity.com/events/{{event.slug}}?event_key={{event.secret_key}}" class="input w-full text-xs " data-target="copy-to-clipboard.input" readonly/>
							</div>
							<button data-action="copy-to-clipboard#copy" class="btn btn-green flex items-center"><i class="fas fa-clipboard mr-2"></i> Copy</button>
						</div>
					</div>
				{%endif%}
				{%if canRSVP%}

					<div class="my-2" id="rsvp-message" data-turbolinks-permanent>
						{{form_messages.messages("rsvp")}}
					</div>
					<div
						class="{{ 'hidden' if (not invite.status) or invite.status === 'invited' }}"
						data-target="event-detail.hasRSVP"
						>
						You RSVP'd as {{invite.status}} -
						<button
							class="hover:underline text-blue-700"
							data-action="event-detail#changeRSVP"
							>
							Change
						</button>
					</div>
						<form
							data-target="event-detail.rsvpForm"
							class="mt-2 border border-gray-200 bg-gray-100 p-2 {{'hidden' if invite.status and invite.status !== 'invited'}}"
							data-action="change->event-detail#rsvp reset->event-detail#toggleRSVP"
							autocomplete="off"
							>
							<h4 class="text-lg font-bold">RSVP</h4>
							<input type="hidden" name="eventId" value="{{event.id}}" />
							<div>
								<label class="font-bold"
											 >Name
											 <input
												 type="text"
												 name="name"
												 value="{{user.name if user }}"
												 class="border-gray-600 border p-1 w-full"
												 placeholder="Your Name"
												 />
								</label>
							</div>

							{%if not user %}
								<div class="mt-2">
									<label class="font-bold">Email or Phone
										<input
											type="text"
											name="email_or_phone"
											value="{{user.name if user }}"
											class="border-gray-600 border p-1 w-full"
											placeholder="Your Email or Phone"
											/>
									</label>
								</div>
							{%endif%}

							<div class="mt-3">
								<fieldset>
									<legend
										class="font-lg text-gray-800 mb-1 font-bold"
										aria-label="RSVP Status"
										>
										Status
									</legend>
										<label class="font-bold cursor-pointer">
											<span class="">Going</span> <input type="radio" name="rsvp"
																																			value="going" {{'checked' if invite.status === 'going'}}/>
										</label>
										-
										<label class="font-bold cursor-pointer">
											<span class="">Maybe</span> <input type="radio" name="rsvp"
																																			value="maybe" {{'checked' if invite.status === 'maybe'}}/>
										</label>
										-

										<label class="font-bold cursor-pointer">
											<span class="">Not Going</span> <input type="radio" name="rsvp"
																																					value="declined" {{'checked' if invite.status === 'declined'}}/>
										</label>
								</fieldset>
							</div>
							<div class="mt-1">
								{%set responded = invite and invite.status !== 'invited'%}
								<label class="cursor-pointer">
									Keep my RSVP private <input type="checkbox" name="show_name"
																															{{'checked' if (responded and not invite.show_name) or (not
																															responded and not event.is_private)}} />
								</label>
								<p>
								<span
									class="text-xs font-bold"
									data-target="event-detail.privateInfo"
									>Only the organizer will see your RSVP</span
								>
								</p>
							</div>
							<div>
								<button
									type="reset"
									class="btn btn-white {{'hidden' if not invite.status or invite.status === 'invited' }}"
									>
									Cancel
								</button>
							</div>
						</form>
					{%endif%}
					<div class="mt-2">
						{%if user and user.id === event.creator.id%}
							You created this event
						{%else%}
							Created by: {{event.creator.name}}
						{%endif%}
					</div>
					<div>
						<p>
						{{"Private" if event.is_private else "Public" | capitalize}} event
						</p>
						{%if not event.is_private%}
							<div class="my-1" id="twitter-section" data-turbolinks-permanent>
								<a
									href="https://twitter.com/share?ref_src=twsrc%5Etfw"
									class="twitter-share-button"
									data-text="{{event.name}}"
									data-show-count="false"
									>Tweet</a
								><script
									 async
									 src="https://platform.twitter.com/widgets.js"
									 charset="utf-8"
									 id="twitter-js"
									 data-turbolinks-permanent
									 ></script>
							</div>
								{%endif%} 					</div>

					<div class="mt-2 md mb-2">
						<details open class="">
							<summary class="cursor-pointer border-b border-gray-300">Description</summary>
							<div class="mt-4">
								{{mdDescription | safe}}
							</div>
						</details>
					</div>
					<hr class="sm:hidden" />
			</div>
			<div
				class="sm:w-1/4 sm:ml-5 p-2 sm:border-l border-gray-300 sm:pl-5 mt-5 sm:mt-0"
				>
				{{form_messages.messages("resend")}}
				<h3 class="text-lg mt-2">Invites</h3>
				{% for status in ["going", "invited", "maybe", "declined"]%}
					<div class="border-b border-gray-300 pb-4 mt-2">
						<h4 class="italic">
							{{status | capitalize}}
						</h4>
						{%if canSeeInvites %}
							{%if event[status].length %}

								<ul class="">
									{%set statusCount = 0%}
									{% for invite in event[status] %}
										{%set person = invite.user%}
										{%set name = person.name or person.email or person.phone%}
										{% if name and name.trim() and (invite.show_name or isCreator or
										invite.user.id === user.id) %}
										<li>
											{%if canInvite %}
												<details class="border border-gray-300 mb-2">
													<summary class="cursor-pointer open:bg-gray-100 open:border-b border-gray-300 px-2">{{name}}</summary>
													<div class="p-2">
														<button
															class="text-blue-700 hover:underline"
															data-id="{{invite.id}}"
															data-action="event-detail#resend"
															>
															Resend Invite

														</button>
													</div>
												</details>
											{%else%}
												<span>{{name}}</span>
											{%endif%}
										</li>
									{% elseif not invite.show_name or not isCreator %}

										{% set statusCount = statusCount+1 %}
									{%endif%}

								{%endfor%}

								{%if statusCount %}

									+{{statusCount}} more {{"person" if statusCount === 1 else "people"}}

								{%endif%}
								</ul>
							{% else %}
								<p class="ml-5 text-xs text-gray-700">---</p>
							{%endif%} {% else %} {{event[status].length}} People {%endif%}
					</div>
				{%endfor%}
			</div>
		</div>
	</div>
{%endblock%}
